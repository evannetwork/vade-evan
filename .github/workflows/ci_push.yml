name: Build & Test - Linux

on:
  push:

env:
  CARGO_TERM_COLOR: always

jobs:
  cache-job:

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          target: x86_64-unknown-linux-gnu
          override: true

      - run: rustup target add x86_64-unknown-linux-gnu

      - name: Install clang for ubuntu
        if: ${{ runner.os == 'ubuntu-latest'}}
        shell: bash
        run: sudo apt install -y clang

      - name: Set up cargo cache
        uses: actions/cache@v3
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build binaries
        run: cargo build --release

  build:
    strategy:
      matrix:
        os:
          - ubuntu-latest

        target:
          - x86_64-unknown-linux-gnu

        toolchain:
          - stable

        feature_bundle:
          - bundle-default
          - bundle-sdk
          - plugin-did-sidetree
          - plugin-did-substrate
          - plugin-didcomm
          - plugin-jwt-vc
          - plugin-vc-zkp-bbs

        feature_target:
          - target-c-lib
          - target-cli
          - target-java-lib
          - target-wasm

        exclude:
          # Don't test linux/windows targets on macos
          - os: macos-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-pc-windows-msvc
          # Don't test darwin/windows targets on ubuntu
          - os: ubuntu-latest
            target: x86_64-apple-darwin
          - os: ubuntu-latest
            target: aarch64-apple-darwin
          - os: ubuntu-latest
            target: x86_64-pc-windows-msvc
          # Don't test darwin/linux targets on windows
          - os: windows-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          components: rustfmt, clippy
          target: ${{ matrix.target }}
          override: true

      - run: rustup target add ${{ matrix.target }}

      - name: Install clang for ubuntu
        if: ${{ matrix.os == 'ubuntu-latest'}}
        shell: bash
        run: sudo apt install -y clang

      - name: Set up cargo cache
        uses: actions/cache@v3
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install wasm-pack (from workaround repository)
        # see https://github.com/rustwasm/wasm-pack/issues/781#issuecomment-1242611389
        # and https://github.com/rustwasm/wasm-pack/issues/823#issuecomment-1242611318
        if: ${{ matrix.feature_target == 'target-wasm'}}
        run: cargo install --git https://github.com/frewsxcv/wasm-pack.git --branch patch-2

      - name: Build WASM file with wasm-pack
        if: ${{ matrix.feature_target == 'target-wasm'}}
        run: wasm-pack build --release --target web -- --no-default-features --features=${{ matrix.feature_bundle }},${{ matrix.feature_target }}

      - name: Build binaries
        if: ${{ matrix.feature_target != 'target-wasm'}}
        run: cargo build --release --target=${{ matrix.target }} --no-default-features --features=${{ matrix.feature_bundle }},${{ matrix.feature_target }}

      - name: Run tests
        run: cargo test --no-default-features --features=${{ matrix.feature_bundle }},${{ matrix.feature_target }}
